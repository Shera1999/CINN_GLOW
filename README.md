# Conditional Invertible Neural Networks for Galaxyâ€‘Cluster Merger History

Welcome to **cINNâ€‘Clusters**, a reproducible pipeline that predicts hidden merger properties of galaxy clusters from observable Xâ€‘ray quantities using a *Conditional Invertible Neural Network* (cINN).
The repository also includes a benchmark MLP ensemble, extensive posteriorâ€‘diagnostic plots, and a featureâ€‘sensitivity analysis.

---

## ğŸŒ Directory Structure

```
CINN_GLOW/
â”œâ”€â”€ scalar/
â”‚   â”œâ”€â”€ data_filter.py              # Pre-processing from raw â†’ scaled CSVs
â”‚   â”œâ”€â”€ model.py                    # cINN architecture (FrEIA + PyTorch)
â”‚   â”œâ”€â”€ train_cinn.py               # Training script for the flow model
â”‚   â”œâ”€â”€ mlp_baseline.py             # 7â€‘member MLP ensemble baseline
â”‚   â”œâ”€â”€ processed_data/             # Generated by data_filter.py
â”‚   â”‚   â”œâ”€â”€ X.csv | Y.csv | meta.csv
â”‚   â”‚   â”œâ”€â”€ obs_scaler.pkl | tar_scaler.pkl
â”‚   â”‚   â””â”€â”€ â€¦ (intermediate files)
â”‚   â”œâ”€â”€ best_cluster_cinn.pt        # Saved model checkpoint (after training)
â”‚   â”œâ”€â”€ 1.posterior_distrubution.png
â”‚   â”œâ”€â”€ 2.prediction_performance1.png
â”‚   â”œâ”€â”€ 2.prediction_performance2.png
â”‚   â”œâ”€â”€ 3.uncertainities.png
â”‚   â”œâ”€â”€ 4.cross_correlations.png
â”‚   â””â”€â”€ 5.sensitivity_analysis.png
â”œâ”€â”€ README.md
â””â”€â”€ requirements.txt
```

All code lives inside the \`\` subâ€‘directory; feel free to reorganise later (e.g., move plotting scripts into their own folder), but the README assumes the structure above for now.

---

## âš™ï¸  Installation

```bash
# clone & enter
git clone <repoâ€‘url> cinn_project
cd cinn_project

# create env & install deps
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

`requirements.txt` lists:

```
pandas numpy torch scikitâ€‘learn joblib matplotlib FrEIA
```

CUDA is autoâ€‘detected if available.

---

## ğŸ“Š Data Preparation

```bash
python data_filter.py \
   --obs_csv  path/to/observables1.csv \
   --unobs_csv path/to/unobservables1.csv \
   --out_dir  processed_data
```

*Creates* `processed_data/` with scaled feature/target matrices plus fitted `StandardScaler` pickles.
`data_filter.py` reproduces the exact train/val/test split used everywhere else by fixing `random_state` to **42**.

---

## ğŸ§© Training the cINN

```bash
python train_cinn.py \
   --processed_dir processed_data \
   --epochs 250
```

*Outputs* `best_cluster_cinn.pt` (saved whenever validation NLL improves).

### Hyperâ€‘parameters

* `hidden_dim=128`, `n_blocks=12`, `clamp=2.0` (Glowâ€‘style affine coupling blocks)
* Optimiser: Adam, `lr=2â€¯Ã—â€¯10â»Â³`

---

## ğŸ·ï¸  Baseline MLP Ensemble & Sensitivity

```bash
python mlp_baseline.py --processed_dir processed_data
```

1. Trains **7** independent MLPs (phaseâ€‘1 MSE â†’ phaseâ€‘2 MAE).
2. Writes median test predictions to `mlp_test_pred.npy` and ground truth to `mlp_test_true.npy`.
3. Produces `sensitivity_matrix.csv` used in Fig.â€¯5.

---

## ğŸ“ˆ Generating Figures

All plotting scripts assume:

* `best_cluster_cinn.pt` exists in project root.
* `processed_data/` contains the preâ€‘processed CSVs & scalers.

Run any script directly, e.g.

```bash
python plotting/posterior_distribution.py            # Fig.Â 1  priorÂ vÂ posterior grid
python plotting/plot_posteriors_all_targets.py       # Fig.Â 2a heatâ€‘maps
python plotting/plot_map_and_error_vs_truth.py       # Fig.Â 2b truthÂ vÂ MAP
python plotting/plot_error_vs_std_scatter.py         # Fig.Â 3  calibration
python plotting/plot_pairwise_all_three.py           # Fig.Â 4  pairwise correlations
python plotting/sensitivity_heatmap.py               # Fig.Â 5  feature sensitivity
```

Each script saves a highâ€‘resolution PNG (and commentedâ€‘out PDF) in the repo root with intuitive file names:

```
posterior_distribution.png
2.prediction_performance1.png
2.prediction_performance2.png
3.uncertainities.png
4.cross_correlations.png
5.sensitivity_analysis.png
```

---

## ğŸ–¼ï¸  Figure Gallery

Below is a quick visual preview of every figure produced by the pipeline.  Each image is downâ€‘scaled for the README; click to view full resolution.

| #       | Visualisation                                                 | Insight                                                                                                                                            |             |                                                               |
| ------- | ------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ------------------------------------------------------------- |
| **1**   | <img src="scalar/1.posterior_distrubution.png" width="260"/>  | **Prior vs Posterior** â€” KDE curves for prior (grey), posterior (blue), MAP (gold) and groundâ€‘truth (red) for every cluster and target (FigureÂ 1). |             |                                                               |
| **2â€¯a** | <img src="scalar/2.prediction_performance1.png" width="260"/> | **Posterior Heatâ€‘maps** â€” How predicted posteriors shift relative to prior bins across all targets (FigureÂ 2a).                                    |             |                                                               |
| **2â€¯b** | <img src="scalar/2.prediction_performance2.png" width="260"/> | **MAP & Error Trends** â€” Groundâ€‘truth vs MAP (top) and absolute error trends (bottom) with percentile bands (FigureÂ 2b).                           |             |                                                               |
| **3**   | <img src="scalar/3.uncertainities.png" width="260"/>          | **Uncertainty Calibration** â€”                                                                                                                      | MAPÂ âˆ’Â truth | versus posterior Ïƒ with Gaussian reference curves (FigureÂ 3). |
| **4**   | <img src="scalar/4.cross_correlations.png" width="260"/>      | **Crossâ€‘correlations** â€” Pairwise scatter of truth, posterior samples and MAP predictions for every target pair (FigureÂ 4).                        |             |                                                               |
| **5**   | <img src="scalar/5.sensitivity_analysis.png" width="260"/>    | **Feature Sensitivity** â€” Î”â€¯MAE heatâ€‘map showing which observables most influence each target (FigureÂ 5).                                          |             |                                                               |

---

## ğŸ¤ Contributing & Issues Contributing & Issues

Pull requests and bug reports are welcome.
Please open an issue for questions or feature requests.

---

## ğŸ“„ License

MITÂ LicenseÂ Â©Â 2025Â YourÂ Name
